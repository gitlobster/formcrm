# its.crm module  
Битрикс модуль. Содержит сущности для отправки данных из вебформы в битрикс 24

a@itlobster.ru  
телеграм: @itlobster



---
Настройки модуля находятся:  
Настройки > Настройки модулей > Crm tools

**Режим отладки**  
При включенном режиме дебага в настройках модуля пишет
отладочную информацию в файл crm-debug.log в корне проекта

**Не отправлять данные в б24**  
При включенной настройке не отправки в б24 в классе сендера
запрещает отправку в б24 данных. Это для работы на локальных копиях
Чтобы можно было почитать логи, но не пропушивать клиенту мусорных лидов

**Адрес куда будет стукаться скрипт**  
Например
"https://site.ru/rest/137/tdm9v335i2kgf2vv/crm.lead.add.json";

---

## Пример использования

```
\Bitrix\Main\Loader::includeModule('form');
$result_id = CFormResult::Add($form_id, $fields);
if ($result_id) {
	...
		if (\Bitrix\Main\Loader::includeModule('its.crm')) {
			$crmForm = new \Its\Crm\Form($form_id, $result_id);
			$crmForm->sendToB24();
		}
	}
	...
```

Модуль работает с уже сохраненной вебформой. Получает на вход ай ди формы
и ай ди результата и сам сходит в базу за данными на отправку.

## Настройка вебформы
Часть настроек берет из описания формы, т.е. прямо из поля DESCRIPTION
Например:

```
TITLE=Заказать расчёт
COMMENTS=#Product# x #Quantity#  <br/>  #Message#
UF_CRM_1582032102=#File#
UF_CRM_1580258505=5948
```

Описание:  
TITLE -- заголовок лида  
COMMENTS -- комментарий  
UF_CRM_1582032102 -- кастомное свойство заведенное в б24 (тип файл)  
UF_CRM_1580258505 -- кастомное свойство источника (с какого сайта), списковое  


#Product# -- это значние из вебформы, код берется из поля SID таблицы  b_form_field   
#Quantity# -- аналогично  
#File# -- аналогично  

Красивые значения SID коды писались напрямую в таблицу, не знаю почему так,
скорее всего для красоты вызовов в коде. 

---------
Если подключен и работает модуль its.utm, то модуль црм попытается пропушить дополинтель
собранные utm метки.


## Повторная отправки лидов
При установке модуля не создается таблица failedlids. Надо делать хайлоад руками
опираясь на сущность, либо дернуть автогенерацию. 
У меня пока руки не дошли, я ее тиражирую через модуль миграции  
local/modules/its.crm/lib/failexportlid.php

Так же для этого функционала надо зарегистрировать агента
```
resendLidToBitrix24();
/local/modules/its.crm/include.php
```

Идея такая, что если б24 лежит по любой причине, то надо, чтобы лид пришел позже.

Повторную отправку лида тестировал на синтетических ситуациях. 
Были ли проблемы в бою -- пока не известно, формально потерянных лидов пока не было.
